#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

# Node should be in $BUILD_DIR/bin/node add it to our path
PATH="$BUILD_DIR/bin:$PATH"

# Set GEM_HOME to be the bundler directory
echo "-----> Installing Compass"
export GEM_HOME=$BUILD_DIR/vendor/bundle/ruby/2.0.0
PATH="$GEM_HOME/bin:$PATH"

if [ -f $BUILD_DIR/grunt.js ] || [ -f $BUILD_DIR/Gruntfile.js ] || [ -f $BUILD_DIR/Gruntfile.coffee ]; then
  run_npm "install grunt-cli"
  echo "-----> Found Gruntfile, running grunt heroku task"
  $BUILD_DIR/node_modules/grunt-cli/bin/grunt heroku
else
  echo "-----> No Gruntfile (grunt.js, Gruntfile.js, Gruntfile.coffee) found"
fi