#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
# set -e

# debug
set -x

# clean up leaking environment
unset GIT_DIR

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

# setting up paths for building
PATH="$VENDORED_SCONS:$VENDORED_NODE/bin:$PATH"
INCLUDE_PATH="$VENDORED_NODE/include"
export CPATH="$INCLUDE_PATH"
export CPPPATH="$INCLUDE_PATH"


echo "-----> Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/bin:\$HOME/node_modules/.bin:\$PATH\"" > $BUILD_DIR/.profile.d/nodejs.sh


which node
gem env

echo "-----> Lets list stuff"

ls -la $BUILD_DIR/node_modules/
ls -la ./vendor/bundle

if [ -f $BUILD_DIR/grunt.js ] || [ -f $BUILD_DIR/Gruntfile.js ] || [ -f $BUILD_DIR/Gruntfile.coffee ]; then
  # make sure that grunt and grunt-cli are installed locally
  echo "-----> Found Gruntfile, running grunt heroku:$NODE_ENV task"
  $BUILD_DIR/node_modules/.bin/grunt heroku:$NODE_ENV
else
  echo "-----> No Gruntfile (grunt.js, Gruntfile.js, Gruntfile.coffee) found"
fi
